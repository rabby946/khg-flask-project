{% extends "member/base.html" %}

{% block title %}Notifications{% endblock %}

{% block member_content %}
<style>
    /* Scoped styles for the Notifications page */
    :root {
        --note-font: 'Poppins', sans-serif;
        --note-primary: #0d6efd;
        --note-success: #198754;
        --note-danger: #dc3545;
        --note-card-bg: #ffffff;
        --note-border: #dee2e6;
        --note-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        --note-text-dark: #212529;
        --note-text-light: #6c757d;
        --note-unread-bg: #e7f1ff;
    }

    .notifications-container {
        font-family: var(--note-font);
        max-width: 800px;
        margin: 1rem auto;
    }

    .notifications-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .notifications-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: var(--note-text-dark);
    }
    .mark-all-read-btn {
        background: none;
        border: 1px solid var(--note-border);
        color: var(--note-text-light);
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .mark-all-read-btn:hover {
        background-color: var(--note-primary);
        color: #fff;
        border-color: var(--note-primary);
    }

    .notifications-list {
        background-color: var(--note-card-bg);
        border: 1px solid var(--note-border);
        border-radius: 1rem;
        box-shadow: var(--note-shadow);
        overflow: hidden;
    }
    
    .notification-item {
        display: flex;
        gap: 1.5rem;
        padding: 1.5rem;
        border-bottom: 1px solid var(--note-border);
        transition: background-color 0.3s ease, opacity 0.4s ease, transform 0.4s ease;
    }
    .notification-item:last-child {
        border-bottom: none;
    }
    .notification-item.is-unread {
        background-color: var(--note-unread-bg);
    }
    
    .notification-item__icon {
        font-size: 1.5rem;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    /* Icon colors for different notification types */
    .notification-item--loan .notification-item__icon { color: var(--note-success); background-color: #e8f5e9; }
    .notification-item--general .notification-item__icon { color: var(--note-primary); background-color: var(--note-unread-bg); }
    .notification-item--alert .notification-item__icon { color: var(--note-danger); background-color: #fdeaea; }

    .notification-item__content {
        flex-grow: 1;
    }
    .notification-item__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.25rem;
    }
    .notification-item__title {
        font-weight: 600;
        color: var(--note-text-dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .notification-item__unread-dot {
        width: 8px;
        height: 8px;
        background-color: var(--note-primary);
        border-radius: 50%;
    }
    .notification-item__timestamp {
        font-size: 0.8rem;
        color: var(--note-text-light);
    }
    .notification-item__message {
        color: var(--note-text-light);
        margin: 0;
    }

    .notification-item__actions {
        opacity: 0;
        transition: opacity 0.3s ease;
        display: flex;
        gap: 0.5rem;
    }
    .notification-item:hover .notification-item__actions {
        opacity: 1;
    }
    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--note-text-light);
        font-size: 1.25rem;
        padding: 5px;
        border-radius: 50%;
    }
    .action-btn:hover {
        background-color: #e9ecef;
    }
    .action-btn.delete:hover { color: var(--note-danger); }

    .no-notifications {
        text-align: center;
        padding: 4rem;
        color: var(--note-text-light);
    }
</style>

<div class="notifications-container" id="notifications-container">
    <div class="notifications-header">
        <h2 class="notifications-title">Notifications</h2>
        {% if notifications %}
            <button class="mark-all-read-btn">Mark all as read</button>
        {% endif %}
    </div>

    {% if notifications %}
        <div class="notifications-list">
            {% for note in notifications %}
                <div class="notification-item {% if not note.is_read %}is-unread{% endif %}" data-id="{{ note.notification_id }}" data-type="{{ note.notification_type }}">
                    <div class="notification-item__icon">
                        {% if 'loan' in note.notification_type|lower %}
                            <i class="fas fa-hand-holding-dollar"></i>
                        {% elif 'alert' in note.notification_type|lower %}
                            <i class="fas fa-exclamation-triangle"></i>
                        {% else %}
                            <i class="fas fa-info-circle"></i>
                        {% endif %}
                    </div>
                    <div class="notification-item__content">
                        <div class="notification-item__header">
                            <h5 class="notification-item__title">
                                {% if not note.is_read %}<span class="notification-item__unread-dot"></span>{% endif %}
                                <span>{{ note.notification_type|capitalize }}</span>
                            </h5>
                            <span class="notification-item__timestamp">{{ note.created_at.strftime("%d %b %Y") }}</span>
                        </div>
                        <p class="notification-item__message">{{ note.message }}</p>
                    </div>
                    <div class="notification-item__actions">
                        {% if not note.is_read %}
                            <button class="action-btn mark-read" title="Mark as Read"><i class="fas fa-check-circle"></i></button>
                        {% else %}
                             <button class="action-btn mark-unread" title="Mark as Unread"><i class="fas fa-envelope-open"></i></button>
                        {% endif %}
                        <button class="action-btn delete" title="Delete"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="notifications-list">
            <p class="no-notifications">You have no new notifications.</p>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('notifications-container');

    container.addEventListener('click', function(e) {
        const button = e.target.closest('.action-btn');
        if (!button) return;

        const item = button.closest('.notification-item');
        const id = item.dataset.id;

        if (button.classList.contains('mark-read')) {
            updateNotificationStatus(id, 'read', item);
        } else if (button.classList.contains('mark-unread')) {
            updateNotificationStatus(id, 'unread', item);
        } else if (button.classList.contains('delete')) {
            if (confirm('Are you sure you want to delete this notification?')) {
                deleteNotification(id, item);
            }
        }
    });

    const markAllReadBtn = container.querySelector('.mark-all-read-btn');
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function() {
            // This endpoint needs to be created in your backend
            fetch('/member/notifications/mark-all-read', { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        document.querySelectorAll('.notification-item.is-unread').forEach(item => {
                            updateReadStateInUI(item, true); // Mark as read
                        });
                    }
                });
        });
    }

    function updateNotificationStatus(id, status, itemElement) {
        fetch(`/member/notifications/${id}/${status}`, { method: "POST" })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    updateReadStateInUI(itemElement, status === 'read');
                }
            });
    }

    function deleteNotification(id, itemElement) {
        fetch(`/member/notifications/${id}/delete`, { method: "POST" })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    itemElement.style.transform = 'translateX(20px)';
                    itemElement.style.opacity = '0';
                    setTimeout(() => {
                        itemElement.remove();
                        // Check if list is now empty
                        if(container.querySelectorAll('.notification-item').length === 0) {
                            container.querySelector('.notifications-list').innerHTML = '<p class="no-notifications">You have no notifications.</p>';
                        }
                    }, 400);
                }
            });
    }
    
    function updateReadStateInUI(itemElement, isRead) {
        const title = itemElement.querySelector('.notification-item__title');
        const unreadDot = title.querySelector('.notification-item__unread-dot');
        const actions = itemElement.querySelector('.notification-item__actions');
        
        if (isRead) {
            itemElement.classList.remove('is-unread');
            if (unreadDot) unreadDot.remove();
            actions.innerHTML = `
                <button class="action-btn mark-unread" title="Mark as Unread"><i class="fas fa-envelope-open"></i></button>
                <button class="action-btn delete" title="Delete"><i class="fas fa-trash-alt"></i></button>
            `;
        } else {
            itemElement.classList.add('is-unread');
            if (!unreadDot) {
                const newDot = document.createElement('span');
                newDot.className = 'notification-item__unread-dot';
                title.prepend(newDot);
            }
            actions.innerHTML = `
                <button class="action-btn mark-read" title="Mark as Read"><i class="fas fa-check-circle"></i></button>
                <button class="action-btn delete" title="Delete"><i class="fas fa-trash-alt"></i></button>
            `;
        }
    }
});
</script>
{% endblock %}